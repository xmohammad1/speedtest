<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تست سرعت اینترنت پایتون</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the application */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Style for the gauge needle */
        #needle {
            transition: transform 0.7s cubic-bezier(0.23, 1, 0.32, 1);
            transform-origin: bottom center;
        }
        /* Keyframe animations for a subtle pulse effect on the 'Go' button */
        @keyframes pulse {
            50% {
                opacity: .8;
                transform: scale(0.95);
            }
        }
        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4 transition-colors duration-500">

    <div class="w-full max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-cyan-400">تست سرعت اینترنت پایتون</h1>
            <p class="text-gray-400 mt-2">ساخته شده با Flask و JavaScript</p>
        </header>

        <main class="flex flex-col items-center">
            <!-- Gauge container -->
            <div class="relative w-80 h-40 overflow-hidden mb-4">
                <svg viewBox="0 0 100 50" class="w-full h-full">
                    <!-- Gauge background arc -->
                    <path d="M 10 50 A 40 40 0 0 1 90 50" stroke="#374151" stroke-width="8" fill="none" stroke-linecap="round"></path>
                    <!-- Gauge progress arc (initially hidden) -->
                    <path id="progress-arc" d="M 10 50 A 40 40 0 0 1 90 50" stroke="url(#gradient)" stroke-width="8" fill="none" stroke-linecap="round" style="stroke-dasharray: 125.6; stroke-dashoffset: 125.6; transition: stroke-dashoffset 0.7s cubic-bezier(0.23, 1, 0.32, 1);"></path>
                    <!-- Gradient definition for the progress arc -->
                    <defs>
                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#22d3ee;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#a5f3fc;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <!-- Needle for the gauge -->
                    <line id="needle" x1="50" y1="50" x2="50" y2="10" stroke="#fde047" stroke-width="2" stroke-linecap="round" style="transform: rotate(-90deg);"></line>
                </svg>
                <!-- Speed display text in the center of the gauge -->
                <div id="speed-display" class="absolute bottom-0 left-1/2 -translate-x-1/2 text-center">
                    <span id="speed-value" class="text-5xl font-bold">0.00</span>
                    <span id="speed-unit" class="text-gray-400 block">مگابیت بر ثانیه</span>
                </div>
            </div>

            <!-- Start button -->
            <button id="start-btn" class="relative bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold rounded-full w-32 h-32 flex items-center justify-center text-3xl shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-cyan-300 focus:ring-opacity-50 disabled:bg-gray-600 disabled:cursor-not-allowed animate-pulse-slow">
                شروع
            </button>
            <div id="status-text" class="mt-4 text-lg text-gray-400 h-6"></div>
        </main>

        <!-- Results section -->
        <footer class="mt-10 grid grid-cols-1 sm:grid-cols-4 gap-4 text-center w-full max-w-2xl mx-auto">
            <div class="bg-gray-800 p-4 rounded-lg">
                <h2 class="text-sm font-semibold text-cyan-400">پینگ</h2>
                <p id="ping-result" class="text-2xl font-bold">- <span class="text-base text-gray-400">ms</span></p>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg">
                <h2 class="text-sm font-semibold text-cyan-400">جیتر</h2>
                <p id="jitter-result" class="text-2xl font-bold">- <span class="text-base text-gray-400">ms</span></p>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg">
                <h2 class="text-sm font-semibold text-cyan-400">دانلود</h2>
                <p id="download-result" class="text-2xl font-bold">- مگابیت بر ثانیه</p>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg">
                <h2 class="text-sm font-semibold text-cyan-400">آپلود</h2>
                <p id="upload-result" class="text-2xl font-bold">- مگابیت بر ثانیه</p>
            </div>
        </footer>
    </div>

    <script>
        // DOM element references
        const startBtn = document.getElementById('start-btn');
        const statusText = document.getElementById('status-text');
        const pingResult = document.getElementById('ping-result');
        const jitterResult = document.getElementById('jitter-result');
        const downloadResult = document.getElementById('download-result');
        const uploadResult = document.getElementById('upload-result');
        const speedValue = document.getElementById('speed-value');
        const speedUnit = document.getElementById('speed-unit');
        const needle = document.getElementById('needle');
        const progressArc = document.getElementById('progress-arc');

        // Configuration for the tests
        const PING_COUNT = 10;
        const DOWNLOAD_TEST_DURATION = 10000; // 10 seconds
        const UPLOAD_TEST_DURATION = 8000; // 8 seconds
        const UPLOAD_DATA_SIZE = 20 * 1024 * 1024; // 20 MB

        // Event listener for the start button
        startBtn.addEventListener('click', runSpeedTest);

        /**
         * Main function to orchestrate the speed test sequence.
         */
        async function runSpeedTest() {
            // Disable button and reset UI
            startBtn.disabled = true;
            startBtn.classList.remove('animate-pulse-slow');
            resetResults();

            try {
                // Run tests sequentially
                const { ping, jitter } = await testPing();
                pingResult.innerHTML = `${ping.toFixed(2)} <span class="text-base text-gray-400">ms</span>`;
                jitterResult.innerHTML = `${jitter.toFixed(2)} <span class="text-base text-gray-400">ms</span>`;

                const downloadSpeed = await testDownload();
                downloadResult.innerHTML = `${downloadSpeed.toFixed(2)} <span class="text-base text-gray-400">Mbps</span>`;

                const uploadSpeed = await testUpload();
                uploadResult.innerHTML = `${uploadSpeed.toFixed(2)} <span class="text-base text-gray-400">Mbps</span>`;

            } catch (error) {
            statusText.textContent = "خطایی در هنگام تست رخ داد.";
                console.error(error);
            } finally {
                // Re-enable button and finalize UI
            statusText.textContent = "تست کامل شد!";
                startBtn.disabled = false;
                startBtn.classList.add('animate-pulse-slow');
                updateGauge(0); // Reset gauge to zero
            }
        }

        /**
         * Resets the UI elements to their initial state.
         */
        function resetResults() {
            statusText.textContent = '';
            pingResult.innerHTML = `- <span class="text-base text-gray-400">ms</span>`;
            jitterResult.innerHTML = `- <span class="text-base text-gray-400">ms</span>`;
            downloadResult.innerHTML = `- <span class="text-base text-gray-400">Mbps</span>`;
            uploadResult.innerHTML = `- <span class="text-base text-gray-400">Mbps</span>`;
            updateGauge(0);
            speedValue.textContent = "0.00";
            speedUnit.textContent = "Mbps";
        }

        /**
         * Measures latency by pinging the server.
         * @returns {Promise<{ping: number, jitter: number}>} Ping and jitter in milliseconds.
         */
        async function testPing() {
            statusText.textContent = 'در حال آزمایش پینگ...';
            const samples = [];
            for (let i = 0; i < PING_COUNT; i++) {
                const startTime = performance.now();
                await fetch(`/ping?t=${Date.now()}`, { cache: 'no-store' });
                const endTime = performance.now();
                samples.push(endTime - startTime);
            }
            const ping = Math.min(...samples);
            let jitter = 0;
            for (let i = 1; i < samples.length; i++) {
                jitter += Math.abs(samples[i] - samples[i - 1]);
            }
            jitter = jitter / (samples.length - 1);
            return { ping, jitter };
        }

        /**
         * Measures download speed.
         * @returns {Promise<number>} The average download speed in Mbps.
         */
        function testDownload() {
            statusText.textContent = 'در حال آزمایش سرعت دانلود...';
            return new Promise(async (resolve, reject) => {
                let totalBytes = 0;
                const startTime = performance.now();
                let testTimeout;

                const controller = new AbortController();
                const signal = controller.signal;

                try {
                    const response = await fetch(`/download?t=${new Date().getTime()}`, { signal });
                    const reader = response.body.getReader();

                    function readChunk() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                // This part is usually not reached due to the timeout
                                finalize();
                                return;
                            }
                            totalBytes += value.length;
                            const elapsedTime = (performance.now() - startTime) / 1000;
                            const speedMbps = (totalBytes * 8) / (elapsedTime * 1000 * 1000);
                            updateGauge(speedMbps);

                            // Continue reading if the test is not over
                            if (performance.now() - startTime < DOWNLOAD_TEST_DURATION) {
                                readChunk();
                            } else {
                                finalize();
                            }
                        }).catch(error => {
                            if (error.name !== 'AbortError') {
                                reject(error);
                            }
                        });
                    }
                    
                    readChunk();

                    // Set a timeout to end the test
                    testTimeout = setTimeout(() => {
                        controller.abort(); // Stop the fetch request
                        finalize();
                    }, DOWNLOAD_TEST_DURATION);

                    function finalize() {
                        clearTimeout(testTimeout);
                        const finalElapsedTime = (performance.now() - startTime) / 1000;
                        const finalSpeedMbps = (totalBytes * 8) / (finalElapsedTime * 1000 * 1000);
                        resolve(finalSpeedMbps);
                    }

                } catch (error) {
                    if (error.name !== 'AbortError') {
                        reject(error);
                    }
                }
            });
        }

        /**
         * Measures upload speed.
         * @returns {Promise<number>} The average upload speed in Mbps.
         */
        function testUpload() {
            statusText.textContent = 'در حال آزمایش سرعت آپلود...';
            return new Promise(async (resolve, reject) => {
                try {
                    // Generate random data to upload
                    const data = new Blob([new Uint8Array(UPLOAD_DATA_SIZE)], { type: 'application/octet-stream' });
                    const startTime = performance.now();
                    
                    // Use XMLHttpRequest for better progress tracking
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/upload', true);

                    xhr.upload.onprogress = (event) => {
                        if (event.lengthComputable) {
                            const elapsedTime = (performance.now() - startTime) / 1000;
                            const speedMbps = (event.loaded * 8) / (elapsedTime * 1000 * 1000);
                            updateGauge(speedMbps);
                        }
                    };

                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            const finalElapsedTime = (performance.now() - startTime) / 1000;
                            const finalSpeedMbps = (UPLOAD_DATA_SIZE * 8) / (finalElapsedTime * 1000 * 1000);
                            resolve(finalSpeedMbps);
                        } else {
                            reject(new Error(`سرور با وضعیت ${xhr.status} پاسخ داد`));
                        }
                    };
                    
                    xhr.onerror = () => reject(new Error('آپلود ناموفق بود'));
                    
                    xhr.send(data);

                } catch (error) {
                    reject(error);
                }
            });
        }
        
        /**
         * Updates the gauge UI based on the current speed.
         * @param {number} speedMbps - The speed in Mbps.
         */
        function updateGauge(speedMbps) {
            speedValue.textContent = speedMbps.toFixed(2);
            
            // The mapping from speed to angle is logarithmic to better display a wide range of speeds
            const logSpeed = Math.log10(speedMbps + 1); // Use +1 to avoid log(0)
            const maxLogSpeed = Math.log10(1000 + 1); // Max speed of 1000 Mbps for scaling
            const angle = (logSpeed / maxLogSpeed) * 180 - 90; // Map to -90 to 90 degrees

            // Clamp the angle to prevent the needle from going too far
            const clampedAngle = Math.max(-90, Math.min(90, angle));
            
            needle.style.transform = `rotate(${clampedAngle}deg)`;
            
            // Update the progress arc
            const totalArcLength = 125.6; // Calculated from the SVG path
            const progress = (clampedAngle + 90) / 180;
            progressArc.style.strokeDashoffset = totalArcLength * (1 - progress);
        }

    </script>
</body>
</html>
